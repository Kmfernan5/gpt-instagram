import { db } from "@/app/drizzle/client";
import { igposts } from "@/app/drizzle/schema";
import { IGApiResponse } from "@/app/ig/DataTypes";
import { createGraph } from "@/app/ig/GraphConfig";
import { NextRequest, NextResponse } from "next/server";

export async function POST(req: NextRequest) {
  const igapi = await fetch(
    `https://graph.instagram.com/me/media?fields=caption,media_url,media_type&access_token=${process.env.IG_ACCESS_TOKEN}`,
  );

  const igres = await igapi.json();
  const igdata: IGApiResponse[] = igres["data"];

  const body = await req.json();
  const graph = createGraph();

  const response = await graph.invoke({
    query: body.userquery,
    igrawdata: JSON.stringify(igdata),
  });

  //SAMPLE RES
  // const response = {
  //   query: "Playing Video Games",
  //   igrawdata: "[{\"caption\":\"üòÅ\",\"media_url\":\"https://scontent-sjc3-1.cdninstagram.com/v/t51.29350-15/437049401_943965147040058_7396000057875129042_n.webp?stp=dst-jpg&_nc_cat=104&ccb=1-7&_nc_sid=18de74&_nc_ohc=-hWCRnfnL7UQ7kNvgGFIIDn&_nc_ht=scontent-sjc3-1.cdninstagram.com&edm=ANo9K5cEAAAA&oh=00_AYBopKsBwjqpqs7JXFw4zJ-roX--MDuU36jqel5ThtuxKw&oe=669A115B\",\"media_type\":\"IMAGE\",\"id\":\"17992164176429557\"},{\"caption\":\"Sasta Chinese Tony Stark???\",\"media_url\":\"https://scontent-sjc3-1.cdninstagram.com/v/t51.29350-15/136353746_1103912143365816_811661047088471975_n.jpg?_nc_cat=107&ccb=1-7&_nc_sid=18de74&_nc_ohc=Z-ddZrAOciIQ7kNvgFXkSw2&_nc_ht=scontent-sjc3-1.cdninstagram.com&edm=ANo9K5cEAAAA&oh=00_AYC2ODZtJT4pQLSPA61XNkrAYwgaCxjDbD4EpI05D2ptYQ&oe=669A0289\",\"media_type\":\"IMAGE\",\"id\":\"18132923389151815\"},{\"caption\":\"Pro tip : Always do it high\",\"media_url\":\"https://scontent-sjc3-1.cdninstagram.com/v/t51.2885-15/44279825_555286478253099_3510417023806584008_n.jpg?_nc_cat=107&ccb=1-7&_nc_sid=18de74&_nc_ohc=cmc_p46cV_oQ7kNvgEbNYdc&_nc_ht=scontent-sjc3-1.cdninstagram.com&edm=ANo9K5cEAAAA&oh=00_AYD2-qLrU-rDelFVJKC_cG3qhY-vvF7HbEwIrbDlx1avAw&oe=669A1B51\",\"media_type\":\"IMAGE\",\"id\":\"17969910415188674\"},{\"caption\":\"Hit this nibba up for some photoshoot and shit @yash____sinha.... Really artistic nibba\",\"media_url\":\"https://scontent-sjc3-1.cdninstagram.com/v/t51.2885-15/43087707_408962256306146_2386499638103782952_n.jpg?_nc_cat=102&ccb=1-7&_nc_sid=18de74&_nc_ohc=w0n4RP5GpQkQ7kNvgFs_fAm&_nc_ht=scontent-sjc3-1.cdninstagram.com&edm=ANo9K5cEAAAA&oh=00_AYBEiwsQBOo_gDkbv0yqtumKrucbRb22vrpq58YXoJxV1g&oe=669A29D4\",\"media_type\":\"IMAGE\",\"id\":\"17964673582164590\"},{\"caption\":\"Those days are gone, now memories are on the wall....\",\"media_url\":\"https://scontent-sjc3-1.cdninstagram.com/v/t51.2885-15/36604684_1055157741329593_4711310271644172288_n.jpg?_nc_cat=109&ccb=1-7&_nc_sid=18de74&_nc_ohc=XTaT0HSNZRIQ7kNvgH-nDli&_nc_ht=scontent-sjc3-1.cdninstagram.com&edm=ANo9K5cEAAAA&oh=00_AYAnAMsyplNX8d0yggDtLvmLUPX-rvaQGCJERVoBnsBlOg&oe=669A06DF\",\"media_type\":\"IMAGE\",\"id\":\"17961484681013189\"},{\"caption\":\"When my bro @aryan.verma1540 steals my caffeine anddd this is what he gets üòÇüòÇüòä\",\"media_url\":\"https://scontent-sjc3-1.cdninstagram.com/v/t51.2885-15/35432188_244832789626052_3795168531654377472_n.jpg?_nc_cat=101&ccb=1-7&_nc_sid=18de74&_nc_ohc=dK94p-1nzrIQ7kNvgGdIA3N&_nc_ht=scontent-sjc3-1.cdninstagram.com&edm=ANo9K5cEAAAA&oh=00_AYCHzBnwyBLy2aELvJ5nUqoBLqClAFDU9uF_m_DRrJYpfQ&oe=6699FC46\",\"media_type\":\"IMAGE\",\"id\":\"17955819463024267\"},{\"caption\":\"When your foot little finger hits a corner but you got to play it cool...üò£üò£üò£\",\"media_url\":\"https://scontent-sjc3-1.cdninstagram.com/v/t51.2885-15/34859722_248519769236424_6347131609518440448_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=18de74&_nc_ohc=ndyOOqr37CYQ7kNvgGqLNq8&_nc_ht=scontent-sjc3-1.cdninstagram.com&edm=ANo9K5cEAAAA&oh=00_AYDPy6t8Vu54Smkyy4Lbozk0Ggf1TsfpGsPKMDTUziwOtg&oe=669A2A44\",\"media_type\":\"IMAGE\",\"id\":\"17929233841141147\"},{\"caption\":\"No Legs Gang riseeeee üôã‚Äç‚ôÇÔ∏èüôÖ‚Äç‚ôÇÔ∏èüôÖ‚Äç‚ôÇÔ∏èüôÖ‚Äç‚ôÄÔ∏è\",\"media_url\":\"https://scontent-sjc3-1.cdninstagram.com/v/t51.2885-15/32359119_211797882947528_8302189770491035648_n.jpg?_nc_cat=103&ccb=1-7&_nc_sid=18de74&_nc_ohc=AZjI820kBnQQ7kNvgFvvxjG&_nc_ht=scontent-sjc3-1.cdninstagram.com&edm=ANo9K5cEAAAA&oh=00_AYDMy61kqDXTo7y4crG1y4kfV8G0XlAnL_tfKTLaFQIMGA&oe=669A06ED\",\"media_type\":\"IMAGE\",\"id\":\"17932586320121728\"},{\"media_url\":\"https://scontent-sjc3-1.cdninstagram.com/v/t51.2885-15/21909522_638716142918868_6378781206342795264_n.jpg?_nc_cat=107&ccb=1-7&_nc_sid=18de74&_nc_ohc=kzn9O8SecCcQ7kNvgEmpRCP&_nc_ht=scontent-sjc3-1.cdninstagram.com&edm=ANo9K5cEAAAA&oh=00_AYB6UV1-aSxamm8xLAYHYKY4c_ZjBTIDHV83z0x-gor1aw&oe=669A025E\",\"media_type\":\"IMAGE\",\"id\":\"17874151369155598\"},{\"caption\":\"I usually don't take pics with my phone but when I do I entirely piss off Anshul.... Damn!  That looks though\",\"media_url\":\"https://scontent-sjc3-1.cdninstagram.com/v/t51.2885-15/17267669_377916855924159_2819638084134502400_n.jpg?_nc_cat=107&ccb=1-7&_nc_sid=18de74&_nc_ohc=_qOuUvaKyZoQ7kNvgFR3XO1&_nc_ht=scontent-sjc3-1.cdninstagram.com&edm=ANo9K5cEAAAA&oh=00_AYDUNyqfZfbDE-aF5b-At4ibWVYzOBrtQiS9qoui2Moj4A&oe=669A0382\",\"media_type\":\"IMAGE\",\"id\":\"17851289854179195\"},{\"caption\":\"üê¶üê¶\",\"media_url\":\"https://scontent-sjc3-1.cdninstagram.com/v/t51.2885-15/16790025_151697492010045_764560825011666944_n.jpg?_nc_cat=104&ccb=1-7&_nc_sid=18de74&_nc_ohc=BEYTHYhbw08Q7kNvgFuuK3d&_nc_ht=scontent-sjc3-1.cdninstagram.com&edm=ANo9K5cEAAAA&oh=00_AYCIShQEiXm_q9Xu7uFPpDpszbJpS0WEMBPY8eIECVdlnQ&oe=669A26D8\",\"media_type\":\"IMAGE\",\"id\":\"17873254855026202\"},{\"caption\":\"Lets see how many threats I get for this pic because its the worst click for today\",\"media_url\":\"https://scontent-sjc3-1.cdninstagram.com/v/t51.2885-15/15875903_1830396530537612_5219209340015083520_n.jpg?_nc_cat=105&ccb=1-7&_nc_sid=18de74&_nc_ohc=wpOFvgNQHbUQ7kNvgGBh1bt&_nc_ht=scontent-sjc3-1.cdninstagram.com&edm=ANo9K5cEAAAA&oh=00_AYAoneiBgQkqgjzvUxz4uUomlJ8DVKvY3edGvamuv5eDVQ&oe=669A2751\",\"media_type\":\"IMAGE\",\"id\":\"17860686361075258\"}]",
  //   igexplaineddata: "[{\"mediaid\":\"17992164176429557\",\"userimagestyle\":\"The first image features three friends enjoying a scenic sunset by the lake. The photo captures a serene and beautiful landscape with the setting sun reflecting off the water, suggesting the suspect enjoys nature and capturing moments with friends in picturesque settings.\",\"usertextstyle\":\"The caption is a simple, happy emoji, suggesting that the suspect may prefer to let the image speak for itself rather than over-explaining or using elaborate text.\"},{\"mediaid\":\"18132923389151815\",\"userimagestyle\":\"The second image is a stylish portrait of the suspect dressed in a suit with red-tinted glasses, giving off a confident and trendy vibe. The suspect might have an interest in fashion and projecting a cool, suave image.\",\"usertextstyle\":\"The caption contains a humorous question with a self-deprecating tone, referring to themselves as a 'Sasta Chinese Tony Stark,' indicating a playful and witty approach to their Instagram posts.\"},{\"mediaid\":\"17969910415188674\",\"userimagestyle\":\"The third image shows a group of friends leaning against a graffiti-covered wall, with one person smoking. The image gives off a rebellious and edgy feel, indicating that the suspect might have an interest in urban settings and unconventional photographs.\",\"usertextstyle\":\"The caption offers a 'Pro tip' with a vague, possibly humorous or ironic statement, 'Always do it high,' indicating the suspect's tendency towards casual, irreverent humor.\"},{\"mediaid\":\"17964673582164590\",\"userimagestyle\":\"The fourth image is a close-up of a group of shirtless friends posing on a beach, with one person prominently smiling at the camera. It suggests a casual, carefree, and fun-loving attitude towards life and photography.\",\"usertextstyle\":\"The caption mentions a friend and describes them as 'really artistic,' showing appreciation and camaraderie. The use of informal language and slang reflects a relaxed and friendly communication style.\"},{\"mediaid\":\"17961484681013189\",\"userimagestyle\":\"The fifth image shows a family standing in a plaza with historical buildings in the background, indicating that the suspect enjoys documenting travel and family moments, capturing memories of significant places and times.\",\"usertextstyle\":\"The nostalgic tone of the caption, 'Those days are gone, now memories are on the wall,' indicates that the suspect values past experiences and cherishes memories, suggesting a reflective and sentimental side.\"},{\"mediaid\":\"17955819463024267\",\"userimagestyle\":\"The sixth image is a playful and candid photo of the suspect playfully choking a friend, both showing exaggerated expressions. This indicates the suspect enjoys fun, spontaneous moments and has a humorous, lighthearted approach to photography.\",\"usertextstyle\":\"The caption is playful and includes mention of a friend with humorous consequences, with the use of emojis adding to the light-hearted tone. This shows a fun-loving and jovial personality.\"},{\"mediaid\":\"17929233841141147\",\"userimagestyle\":\"The seventh image is a close-up side profile of the suspect, possibly taken outdoors. This type of image might suggest that the suspect likes to capture different facets of their personality through detailed and focused shots.\",\"usertextstyle\":\"The caption humorously describes a painful but common experience ('foot little finger hits a corner') with a series of strained emojis, reflecting the suspect's use of relatable humor and expressive language.\"},{\"mediaid\":\"17932586320121728\",\"userimagestyle\":\"The eighth image is a mirror selfie of the suspect at the gym. The image indicates that the suspect cares about fitness and likes documenting their gym routines or physical progress.\",\"usertextstyle\":\"The caption, with the phrase 'No Legs Gang riseeeee,' uses humor and informal language to create a sense of camaraderie among like-minded followers. The emojis add a playful touch, indicating a youthful and casual communication style.\"},{\"mediaid\":\"17851289854179195\",\"userimagestyle\":\"The ninth image shows a group selfie with friends near a body of water. This suggests the suspect enjoys spending time with friends and capturing group moments, often in scenic or outdoor locations.\",\"usertextstyle\":\"The caption includes a comment about infrequent phone photography and a playful jab at a friend, reflecting a combination of self-awareness and humor. The expressive language and informal tone further illustrate a casual and jovial writing style.\"},{\"mediaid\":\"17873254855026202\",\"userimagestyle\":\"The tenth image is a candid photo of the suspect on a scooter, giving the middle finger to the camera. This suggests a rebellious, carefree, and bold attitude towards life and photography.\",\"usertextstyle\":\"The caption consists solely of bird emojis, adding a layer of playful defiance to match the image. The minimal use of text and reliance on emojis indicate a preference for visual communication with humorous and rebellious undertones.\"},{\"mediaid\":\"17860686361075258\",\"userimagestyle\":\"The eleventh image is a blurry, casual group photo, suggesting spontaneity and a focus on capturing moments with friends or family regardless of the photo quality.\",\"usertextstyle\":\"The caption humorously acknowledges the poor quality of the photo and anticipates reactions, showing a self-aware and light-hearted approach. It indicates the suspect's ability to laugh at themselves and maintain a casual, friendly rapport with their audience.\"}]",
  //   userimagestyle: "The suspect's Instagram posts provide a comprehensive insight into their personality and interests. The first image depicts a serene sunset scene with friends, showing an appreciation for nature and capturing moments with loved ones. In the second image, the suspect appears stylish and confident, indicating an interest in fashion and projecting a cool image. The third image portrays a rebellious and edgy vibe with friends in an urban setting, suggesting a fondness for unconventional photography. The fourth image showcases a carefree and fun-loving attitude, while the fifth image highlights a nostalgic and sentimental side with a focus on family and travel memories. The sixth image reflects a fun-loving and jovial personality, and the seventh image suggests a desire to showcase different facets of their personality through detailed shots. The eighth image indicates a commitment to fitness and documenting gym routines. The ninth image emphasizes spending time with friends in scenic locations, and the tenth image conveys a rebellious and bold attitude. The eleventh image, despite its poor quality, shows a casual and spontaneous approach to photography, capturing moments with loved ones regardless of perfection.",
  //   usertextstyle: "The caption analysis reveals a playful and light-hearted tone in the suspect's communication style. They use humor, sarcasm, and emojis to engage with their audience, showcasing a witty and relaxed persona. The captions offer insights into the suspect's values, such as camaraderie, nostalgia, and self-awareness. The suspect enjoys sharing personal experiences, humorous anecdotes, and relatable moments with their followers. They exhibit a comfortable and friendly writing style, building a sense of community and connection through their posts. Overall, the suspect comes across as a multifaceted individual with a love for nature, fashion, urban culture, fitness, and social interactions, blending humor, sentimentality, and boldness in their online presence.",
  //   researcheddata: "[{\"postid\":\"1\",\"imagepromt\":\"A group of friends enjoying a competitive video game tournament with intense focus and excitement.\",\"caption\":\"When the game gets serious with friends! üéÆ Who will emerge victorious? Tag your gaming squad!\",\"tags\":[\"#GamingSquad\",\"#VideoGameTournament\",\"#FriendshipGoals\"]},{\"postid\":\"2\",\"imagepromt\":\"A stylish and confident gamer showcasing their gaming setup with futuristic lighting and sleek design.\",\"caption\":\"Gaming setup goals! üíª‚ú® Ready to dive into the virtual world. What's your favorite game to play?\",\"tags\":[\"#GamingSetup\",\"#VirtualReality\",\"#GamerLife\"]},{\"postid\":\"3\",\"imagepromt\":\"An edgy and rebellious gamer immersed in a dark and intense video game environment.\",\"caption\":\"Lost in the virtual realm... üéÆüî• Embracing the challenge and conquering the unknown. #GamerVibes\",\"tags\":[\"#GamerVibes\",\"#VirtualRealm\",\"#ChallengeAccepted\"]},{\"postid\":\"4\",\"imagepromt\":\"A carefree gamer laughing while playing a fun and lighthearted video game with colorful graphics.\",\"caption\":\"Just a casual gaming session filled with laughter and joy! üåàüéÆ Who said gaming isn't fun? #GamerLife\",\"tags\":[\"#CasualGaming\",\"#JoyfulMoments\",\"#ColorfulGraphics\"]},{\"postid\":\"5\",\"imagepromt\":\"A nostalgic gamer surrounded by retro video game consoles and memorabilia, reminiscing about the good old days.\",\"caption\":\"Throwback to the classics! üïπÔ∏è‚ú® Reliving the memories of childhood gaming adventures. #NostalgiaTrip\",\"tags\":[\"#ThrowbackGaming\",\"#ChildhoodMemories\",\"#RetroGaming\"]},{\"postid\":\"6\",\"imagepromt\":\"A fun-loving gamer celebrating a gaming achievement with confetti and excitement.\",\"caption\":\"Victory dance in the virtual world! üéâüéÆ Embracing the wins and enjoying the journey. #GamerAchievement\",\"tags\":[\"#VictoryDance\",\"#GamerJourney\",\"#CelebrationTime\"]}]",
  //   critiquefeedback: "[{\"postid\":\"1\",\"imagepromtfeedback\":\"okay\",\"igcaptionfeedback\":\"okay\",\"tagsfeedback\":\"okay\"},{\"postid\":\"2\",\"imagepromtfeedback\":\"okay\",\"igcaptionfeedback\":\"okay\",\"tagsfeedback\":\"okay\"},{\"postid\":\"3\",\"imagepromtfeedback\":\"okay\",\"igcaptionfeedback\":\"okay\",\"tagsfeedback\":\"okay\"},{\"postid\":\"4\",\"imagepromtfeedback\":\"okay\",\"igcaptionfeedback\":\"okay\",\"tagsfeedback\":\"okay\"},{\"postid\":\"5\",\"imagepromtfeedback\":\"okay\",\"igcaptionfeedback\":\"okay\",\"tagsfeedback\":\"okay\"},{\"postid\":\"6\",\"imagepromtfeedback\":\"okay\",\"igcaptionfeedback\":\"okay\",\"tagsfeedback\":\"okay\"}]",
  //   resdatawithimages: "[{\"postid\":\"1\",\"imagepromt\":\"A group of friends enjoying a competitive video game tournament with intense focus and excitement.\",\"caption\":\"When the game gets serious with friends! üéÆ Who will emerge victorious? Tag your gaming squad!\",\"tags\":[\"#GamingSquad\",\"#VideoGameTournament\",\"#FriendshipGoals\"],\"imageurl\":\"https://oaidalleapiprodscus.blob.core.windows.net/private/org-IICHOC2cC2iP4WlYnvimZy7P/user-kwdmHMlpY4NCmIW8BTUE1BZ6/img-DsZEOoEkdOiqo6o725T6U22R.png?st=2024-07-14T20%3A20%3A43Z&se=2024-07-14T22%3A20%3A43Z&sp=r&sv=2023-11-03&sr=b&rscd=inline&rsct=image/png&skoid=6aaadede-4fb3-4698-a8f6-684d7786b067&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2024-07-14T17%3A06%3A07Z&ske=2024-07-15T17%3A06%3A07Z&sks=b&skv=2023-11-03&sig=ehfxvIexeJxdbrXF0OMx9youxbZHiEFOH/owvwMXSlM%3D\"},{\"postid\":\"2\",\"imagepromt\":\"A stylish and confident gamer showcasing their gaming setup with futuristic lighting and sleek design.\",\"caption\":\"Gaming setup goals! üíª‚ú® Ready to dive into the virtual world. What's your favorite game to play?\",\"tags\":[\"#GamingSetup\",\"#VirtualReality\",\"#GamerLife\"],\"imageurl\":\"https://oaidalleapiprodscus.blob.core.windows.net/private/org-IICHOC2cC2iP4WlYnvimZy7P/user-kwdmHMlpY4NCmIW8BTUE1BZ6/img-2vQbwZnNxopM4Vu2A708YIZl.png?st=2024-07-14T20%3A20%3A52Z&se=2024-07-14T22%3A20%3A52Z&sp=r&sv=2023-11-03&sr=b&rscd=inline&rsct=image/png&skoid=6aaadede-4fb3-4698-a8f6-684d7786b067&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2024-07-14T01%3A36%3A17Z&ske=2024-07-15T01%3A36%3A17Z&sks=b&skv=2023-11-03&sig=dIUxiOprGAE5QeTqP28QklrBcWLa6LCiPGQQChbNhnI%3D\"},{\"postid\":\"3\",\"imagepromt\":\"An edgy and rebellious gamer immersed in a dark and intense video game environment.\",\"caption\":\"Lost in the virtual realm... üéÆüî• Embracing the challenge and conquering the unknown. #GamerVibes\",\"tags\":[\"#GamerVibes\",\"#VirtualRealm\",\"#ChallengeAccepted\"],\"imageurl\":\"https://oaidalleapiprodscus.blob.core.windows.net/private/org-IICHOC2cC2iP4WlYnvimZy7P/user-kwdmHMlpY4NCmIW8BTUE1BZ6/img-yd44xJkVXLHeAeOXoVELzzan.png?st=2024-07-14T20%3A21%3A03Z&se=2024-07-14T22%3A21%3A03Z&sp=r&sv=2023-11-03&sr=b&rscd=inline&rsct=image/png&skoid=6aaadede-4fb3-4698-a8f6-684d7786b067&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2024-07-14T02%3A08%3A15Z&ske=2024-07-15T02%3A08%3A15Z&sks=b&skv=2023-11-03&sig=gaU0j6AtwUAfAj0Z2pWzITUuAdaGz0bawmAyWvLVHq4%3D\"},{\"postid\":\"4\",\"imagepromt\":\"A carefree gamer laughing while playing a fun and lighthearted video game with colorful graphics.\",\"caption\":\"Just a casual gaming session filled with laughter and joy! üåàüéÆ Who said gaming isn't fun? #GamerLife\",\"tags\":[\"#CasualGaming\",\"#JoyfulMoments\",\"#ColorfulGraphics\"],\"imageurl\":\"https://oaidalleapiprodscus.blob.core.windows.net/private/org-IICHOC2cC2iP4WlYnvimZy7P/user-kwdmHMlpY4NCmIW8BTUE1BZ6/img-kbjh46ohn2GZL73APQOF7h0y.png?st=2024-07-14T20%3A21%3A12Z&se=2024-07-14T22%3A21%3A12Z&sp=r&sv=2023-11-03&sr=b&rscd=inline&rsct=image/png&skoid=6aaadede-4fb3-4698-a8f6-684d7786b067&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2024-07-14T20%3A08%3A32Z&ske=2024-07-15T20%3A08%3A32Z&sks=b&skv=2023-11-03&sig=8BKwpk%2B0QrDExx07pWHn5KhDzn7%2BUN6oE7Q1JZRLG9E%3D\"},{\"postid\":\"5\",\"imagepromt\":\"A nostalgic gamer surrounded by retro video game consoles and memorabilia, reminiscing about the good old days.\",\"caption\":\"Throwback to the classics! üïπÔ∏è‚ú® Reliving the memories of childhood gaming adventures. #NostalgiaTrip\",\"tags\":[\"#ThrowbackGaming\",\"#ChildhoodMemories\",\"#RetroGaming\"],\"imageurl\":\"https://oaidalleapiprodscus.blob.core.windows.net/private/org-IICHOC2cC2iP4WlYnvimZy7P/user-kwdmHMlpY4NCmIW8BTUE1BZ6/img-U29AqFyKSxJaJMvJrdXJ7l4d.png?st=2024-07-14T20%3A21%3A20Z&se=2024-07-14T22%3A21%3A20Z&sp=r&sv=2023-11-03&sr=b&rscd=inline&rsct=image/png&skoid=6aaadede-4fb3-4698-a8f6-684d7786b067&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2024-07-14T13%3A31%3A51Z&ske=2024-07-15T13%3A31%3A51Z&sks=b&skv=2023-11-03&sig=fnMXyK3XXgWDEf10gMsjao7hYwaZUaNbIItCVT%2BI3Wo%3D\"},{\"postid\":\"6\",\"imagepromt\":\"A fun-loving gamer celebrating a gaming achievement with confetti and excitement.\",\"caption\":\"Victory dance in the virtual world! üéâüéÆ Embracing the wins and enjoying the journey. #GamerAchievement\",\"tags\":[\"#VictoryDance\",\"#GamerJourney\",\"#CelebrationTime\"],\"imageurl\":\"https://oaidalleapiprodscus.blob.core.windows.net/private/org-IICHOC2cC2iP4WlYnvimZy7P/user-kwdmHMlpY4NCmIW8BTUE1BZ6/img-htlBixzRc1DD23IHfIhLECSR.png?st=2024-07-14T20%3A21%3A29Z&se=2024-07-14T22%3A21%3A29Z&sp=r&sv=2023-11-03&sr=b&rscd=inline&rsct=image/png&skoid=6aaadede-4fb3-4698-a8f6-684d7786b067&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2024-07-14T00%3A00%3A55Z&ske=2024-07-15T00%3A00%3A55Z&sks=b&skv=2023-11-03&sig=wJW1T/PzGSuMFgxlWjlwHPVcj8RvLCDj2QkZzEjGEAw%3D\"}]",
  // }

  const graphresObj = JSON.parse(response.resdatawithimages)

  

  const datatosave = graphresObj.map((entry: any) => {
    return {
      'imageurl': entry.imageurl,
      'imagepromt' : entry.imagepromt,
      'caption': entry.caption,
      'tags': entry.tags,
    }
  });

  const saveInDb = await db.insert(igposts).values(datatosave);

  if (response && saveInDb) {
    return NextResponse.json(graphresObj, { status: 200 });
  } else {
    return NextResponse.json(
      { error: "Agent Failed Try Again" },
      { status: 500 },
    );
  }
}
